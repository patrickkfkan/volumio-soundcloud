{"version":3,"file":"TrackViewHandler.js","sourceRoot":"","sources":["../../../../../src/lib/controller/browse/view-handlers/TrackViewHandler.ts"],"names":[],"mappings":"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","sourcesContent":["import sc from '../../../SoundCloudContext';\nimport { ModelType } from '../../../model';\nimport { TrackModelGetTracksParams } from '../../../model/TrackModel';\nimport ExplodableViewHandler, { ExplodedTrackInfo } from './ExplodableViewHandler';\nimport View from './View';\nimport { RenderedPage } from './ViewHandler';\nimport { RendererType } from './renderers';\n\nexport interface TrackView extends View {\n  name: 'tracks' | 'track';\n  search?: string;\n  userId?: string;\n  topFeatured?: '1';\n  myLikes?: '1';\n  combinedSearch?: '1';\n  title?: string;\n  // Explode\n  trackId?: string;\n}\n\nexport default class TrackViewHandler extends ExplodableViewHandler<TrackView> {\n\n  async browse(): Promise<RenderedPage> {\n    const { pageRef, search, userId, topFeatured, myLikes, combinedSearch, inSection } = this.currentView;\n    const pageToken = pageRef?.pageToken;\n    const pageOffset = pageRef?.pageOffset;\n\n    if (!search && userId === undefined && !topFeatured && !myLikes) {\n      throw Error('Unknown criteria');\n    }\n\n    const modelParams: TrackModelGetTracksParams = {};\n\n    if (pageToken) {\n      modelParams.pageToken = pageRef.pageToken;\n    }\n    if (pageOffset) {\n      modelParams.pageOffset = pageRef.pageOffset;\n    }\n\n    if (search) {\n      modelParams.search = search;\n    }\n    else if (userId) {\n      modelParams.userId = Number(userId);\n    }\n    else if (topFeatured) {\n      modelParams.topFeatured = true;\n    }\n\n    if (search && combinedSearch) {\n      modelParams.limit = sc.getConfigValue('combinedSearchResults');\n    }\n    else if (inSection) {\n      modelParams.limit = sc.getConfigValue('itemsPerSection');\n    }\n    else {\n      modelParams.limit = sc.getConfigValue('itemsPerPage');\n    }\n\n    let tracks;\n    if (myLikes) {\n      tracks = await this.getModel(ModelType.Me).getLikes({...modelParams, type: 'track'});\n    }\n    else {\n      tracks = await this.getModel(ModelType.Track).getTracks(modelParams);\n    }\n\n    const page = this.buildPageFromLoopFetchResult(\n      tracks,\n      this.getRenderer(RendererType.Track),\n      myLikes ? sc.getI18n('SOUNDCLOUD_LIKES') : sc.getI18n('SOUNDCLOUD_LIST_TITLE_TRACKS')\n    );\n\n    if (userId && !inSection) {\n      const userData = await this.getModel(ModelType.User).getUser(Number(userId));\n      if (userData) {\n        const header = this.getRenderer(RendererType.User).renderToHeader(userData);\n        if (header && page.navigation) {\n          page.navigation.info = header;\n        }\n      }\n    }\n\n    return page;\n  }\n\n  protected async getTracksOnExplode(): Promise<ExplodedTrackInfo | ExplodedTrackInfo[]> {\n    const { trackId } = this.currentView;\n    if (!trackId) {\n      throw Error('No Track ID specified');\n    }\n    const track = await this.getModel(ModelType.Track).getTrack(Number(trackId));\n    if (!track) {\n      return [];\n    }\n    const explodedTrackInfo: ExplodedTrackInfo = {...track};\n\n    // Check if previous view is 'albums@albumId=...' or 'playlists@playlistId...'\n    // If so, we include the playlistId in the result for goto(album).\n    const prev = this.previousViews[this.previousViews.length - 1] || {};\n    if (prev.name === 'albums' && prev.albumId) {\n      explodedTrackInfo.fromAlbumId = prev.albumId;\n    }\n    else if (prev.name === 'playlists' && prev.playlistId && prev.type !== 'system') {\n      explodedTrackInfo.fromPlaylistId = prev.playlistId;\n    }\n\n    return explodedTrackInfo;\n  }\n}\n"]}